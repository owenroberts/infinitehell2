class Camera{constructor(){this.view=[0,0,gme.width,gme.height],this.zoom=1.5,this.center=[0,0],this.focus=[0,0],this.state="view",this.lerp={center:[0,0],focus:[0,0],speed:8,threshold:.05},this.waitToSet=!1}lerpToPlayer(){"view"==this.state&&(this.lerp.center=[...this.center],this.lerp.focus=[...this.focus],this.state="lerp")}update(){if("lerp"===this.state){let e=-player.x-player.halfWidth,t=-player.y-player.halfHeight,s=[(e-this.lerp.center[0])/this.lerp.speed,(t-this.lerp.center[1])/this.lerp.speed];this.lerp.center[0]+=s[0],this.lerp.center[1]+=s[1];let i=[(gme.halfWidth-this.lerp.focus[0])/this.lerp.speed,(gme.halfHeight-this.lerp.focus[1])/this.lerp.speed];this.lerp.focus[0]+=i[0],this.lerp.focus[1]+=i[1],gme.ctx.translate(Math.floor(this.lerp.focus[0]),Math.floor(this.lerp.focus[1])),gme.ctx.translate(Math.floor(this.lerp.center[0]),Math.floor(this.lerp.center[1])),(Math.abs(s[0])<this.lerp.threshold||Math.abs(s[1])<this.lerp.threshold)&&(this.state="view",this.focus=[gme.halfWidth,gme.halfHeight],this.center=[-player.x-player.halfWidth,-player.y-player.halfHeight]),this.view[0]=-this.lerp.focus[0]-this.lerp.center[0],this.view[1]=-this.lerp.focus[1]-this.lerp.center[1]}else"player"===this.state?(gme.ctx.translate(gme.halfWidth,gme.halfHeight),gme.ctx.translate(-player.x-player.halfWidth,-player.y-player.halfHeight),this.view[0]=-gme.halfWidth+player.x+player.halfWidth,this.view[1]=-gme.halfHeight+player.y+player.halfHeight):"view"===this.state&&(gme.ctx.translate(this.focus[0],this.focus[1]),gme.ctx.translate(this.center[0],this.center[1]),this.view[0]=-this.focus[0]-this.center[0],this.view[1]=-this.focus[1]-this.center[1])}}const Constants={TILE_SIZE:64,HALF_TILE_SIZE:32,CELL_WIDTH:3,CELL_HEIGHT:1,GRID_WIDTH:3,GRID_HEIGHT:3,PLAYER_START_X:480,PLAYER_START_Y:-512,PLAYER_JUMP_SPEED:-16,CAMERA_START_X:-320,PLAYER_CATEGORY:2,PLATFORM_CATEGORY:4,TRIGGER_CATEGORY:8};class HellSprite extends Entity{constructor(e,t){super(e,t)}display(e){this.isOnScreen(e)&&(this.debug&&this.drawDebug(),this.animation&&(this.animation.update(),this.animation.draw(this.x,this.y,GAME.suspend))),this.displayFunc&&this.displayFunc()}}class HellTextureSprite extends HellSprite{constructor(e,t){super(e,t),this.center=!1,this.stateName=`frame-${e.stateIndex}`,this.animation.createNewState(`frame-${e.stateIndex}`,e.stateIndex,e.stateIndex)}display(e){this.animation.state=this.stateName,super.display(e)}}class Level{constructor(e,t,s,i,n){this.indexes=e,this.x=t,this.y=s;let o=gme.anims.sprites.platforms.endFrame;this.animationFrame=Math.min(o,Math.max(0,Math.floor(o/2)+1+e[1])),this.tiles=[],this.tilesAdded=!1,this.tilePositions=[],this.tileCount=0,this.levelType=n,s>gme.lowestLevel&&(gme.lowestLevel=s),this.width=Constants.TILE_SIZE*Constants.CELL_WIDTH*Constants.GRID_WIDTH,this.height=Constants.TILE_SIZE*Constants.CELL_HEIGHT*Constants.GRID_HEIGHT,this.trigger=physics.addTrigger(this.indexes,t+this.width/2,s,this.width,this.height,(()=>{if(this.indexes[0]===gme.currentLevel[0]&&this.indexes[1]===gme.currentLevel[1])return;let e=gme.currentLevel[1]-this.indexes[1];gme.currentLevel[0]=this.indexes[0],gme.currentLevel[1]=this.indexes[1];for(let e=0;e<gme.levels.length;e++){let t=gme.levels[e].indexes,s=Math.abs(t[0]-this.indexes[0]),i=Math.abs(t[1]-this.indexes[1]);(s>3||i>3)&&gme.levels[e].remove()}this.addLevels(7),doodoo&&(doodoo.moveTonic(2*e),doodoo.moveBPM(2*e)),player.jumpSpeed-=e/2,this.indexes[1]>0?(gme.anims.sprites.platforms.overrideProperty("wiggleRange",Math.abs(this.indexes[1])/4),gme.anims.sprites.platforms.overrideProperty("wiggleSpeed",Math.abs(this.indexes[1])/8),gme.anims.sprites.platforms.overrideProperty("wiggleSegments",!0)):gme.anims.sprites.platforms.cancelOverride()})),gme.levels.push(this),i>=2&&this.addPlatforms(n),i>=1&&this.addLevels(i)}updateTiles(){if(this.tileCount===this.tilePositions.length)return;let[e,t]=this.tilePositions[this.tileCount];this.tiles.push(physics.addBody(e,t,Constants.TILE_SIZE,this.animationFrame)),this.tileCount++}addPlatforms(e){if(this.tilesAdded)return;if(!player.landed&&0==this.indexes[0]&&this.indexes[1]<0)return;this.tilesAdded=!0;let{x:t,y:s}=this;e||((e="000000000".split(""))[Cool.randomInt(9)]="1",e[Cool.randomInt(9)]="1",e=e.join(""));for(let i=0;i<9;i++)if(+e.charAt(i)){let e=i%3*Constants.TILE_SIZE*Constants.CELL_WIDTH+Constants.HALF_TILE_SIZE,n=Math.floor(i/3)*Constants.TILE_SIZE*Constants.CELL_HEIGHT-Constants.TILE_SIZE;this.tilePositions.push([t+e,s+n]),this.tilePositions.push([t+e+Constants.TILE_SIZE,s+n]),this.tilePositions.push([t+e+2*Constants.TILE_SIZE,s+n])}}addLevel(e,t){let s=gme.levels.filter((t=>t.indexes[0]===e[0]&&t.indexes[1]===e[1]));if(s.length)return void(t>=1&&s.forEach((e=>{0===e.tiles.length&&e.addPlatforms()})));let i=this.width*e[0],n=this.height*e[1];new Level(e,i,n,t)}addLevels(e){e-=1;for(let t=1;t<=4;t++){let s=[this.indexes[0]+(t<=2?1:-1),this.indexes[1]+(t%2==0?1:-1)];this.addLevel(s,e)}}remove(){for(let e=0;e<this.tiles.length;e++)Composite.remove(physics.engine.world,this.tiles[e].body),gme.scenes.game.remove(this.tiles[e]);Composite.remove(physics.engine.world,this.trigger),gme.levels.splice(gme.levels.indexOf(this),1)}}class Physics{constructor(){this.display=!1,this.engine=Engine.create(),this.engine.gravity.y=2,this.defaultOptions={restitution:.1,friction:.05}}addBody(e,t,s,i){const n=new HellTextureSprite({x:e+Cool.randomInt(-Constants.TILE_SIZE/4,Constants.TILE_SIZE/4),y:t+Cool.randomInt(Constants.TILE_SIZE/4),animation:gme.anims.sprites.platforms,stateIndex:i});return n.center=!0,gme.scenes.game.addSprite(n),n.body=Bodies.rectangle(Math.round(e),Math.round(t),s,s,{...this.defaultOptions,collisionFilter:{category:Constants.PLATFORM_CATEGORY},isStatic:!0}),n.body.isPlatform=!0,Composite.add(this.engine.world,n.body),n}addTrigger(e,t,s,i,n,o){const l=Bodies.rectangle(Math.round(t),Math.round(s),i,n,{isStatic:!0,isSensor:!0,collisionFilter:{category:Constants.TRIGGER_CATEGORY}});return l.isTrigger=!0,l.levelIndex=e,l.callback=o,Composite.add(this.engine.world,l),l}render(e){if(this.display){let t=gme.ctx.lineWidth,s=gme.ctx.strokeStyle;gme.ctx.lineWidth=1,gme.ctx.strokeStyle="#00dd22";const i=Composite.allBodies(this.engine.world);for(let t=0,s=i.length;t<s;t++){const s=i[t];gme.ctx.beginPath();for(let t=0,i=s.parts.length;t<i;t++){const i=s.parts[t];gme.ctx.moveTo(i.vertices[0].x+e[0],i.vertices[0].y+e[1]);for(let t=1,s=i.vertices.length;t<s;t++)gme.ctx.lineTo(i.vertices[t].x+e[0],i.vertices[t].y+e[1]);gme.ctx.lineTo(i.vertices[0].x+e[0],i.vertices[0].y+e[1])}gme.ctx.stroke()}gme.ctx.lineWidth=t,gme.ctx.strokeStyle=s}}}class Player extends HellSprite{constructor(e,t,s,i){super({x:GAME.halfWidth,y:GAME.halfHeight}),this.mapPosition=[Math.round(e),Math.round(t)],this.center=!0,this.debug=i||!1,this.speed=[1,1],this.jumpSpeed=Constants.PLAYER_JUMP_SPEED,this.jumpJustPressed=!1,this.isJumping=!0,this.jumpCount=0,this.jumpMax=2,this.pass=!1,this.plats=[],this.addAnimation(s),this.animation.state="idle_right",this.direction=1,this.input={right:!1,up:!1,left:!1,down:!1,jump:!1},this.hasSFX=!1,this.landed=!1,this.setupPhysics()}setupPhysics(){let e=[];this.blocked={down:null,up:null,right:null,left:null},this.sensors={};let[t,s]=this.mapPosition,[i,n]=[56,56];this.sensors.down=Bodies.rectangle(t,s+n/2,i/2,10,{isSensor:!0}),e.push(this.sensors.down),e.push(Bodies.rectangle(t,s,i,n));const o={inertia:1/0,restitution:.25,friction:.05,parts:e,collisionFilter:{category:Constants.PLAYER_CATEGORY,mask:Constants.PLATFORM_CATEGORY|Constants.TRIGGER_CATEGORY}};this.body=Body.create(o),this.body.isPlayer=!0,Composite.add(physics.engine.world,this.body),Events.on(physics.engine,"afterUpdate",this.physicsUpdate.bind(this)),Events.on(physics.engine,"beforeUpdate",(e=>{this.blocked.down=!1})),Events.on(physics.engine,"collisionActive",(e=>{let t=e.pairs;for(let e=0,s=t.length;e<s;e++){let s=t[e];s.bodyA!==this.sensors.down&&s.bodyB!==this.sensors.down||s.bodyA.isTrigger||s.bodyB.isTrigger||(this.blocked.down=!0,player.landed||(player.landed=!0)),(s.bodyA.isPlatform||s.bodyB.isPlatform)&&console.log(s.bodyA.isPlatform,s.bodyB.parent.isPlayer,s.bodyB.isPlatform,s.bodyA.parent.isPlayer)}})),Events.on(physics.engine,"collisionStart",(e=>{if(!player.landed)return;let t=e.pairs;for(let e=0,s=t.length;e<s;e++){let s=t[e];s.bodyA.isTrigger&&s.bodyB.parent.isPlayer?s.bodyA.callback():s.bodyB.isTrigger&&s.bodyA.parent.isPlayer&&s.bodyB.callback()}}))}inputKey(e,t){this.landed&&(this.input[e]=t)}reset(){player.landed=!1,this.jumpSpeed=Constants.PLAYER_JUMP_SPEED,this.input.right=!1,this.input.left=!1,this.input.jump=!1,Body.setPosition(this.body,{x:Constants.PLAYER_START_X,y:Constants.PLAYER_START_Y}),Body.setVelocity(this.body,{x:0,y:0})}physicsUpdate(){this.blocked.down&&this.isJumping&&(this.isJumping=!1,this.jumpCount=0,this.animation.cancelOverride(),this.hasSFX&&this.sfx.jump[0].play()),this.input.jump?(this.jumpJustPressed||(this.blocked.down||this.jumpCount<this.jumpMax)&&(Body.setVelocity(this.body,{x:this.body.velocity.x,y:this.jumpSpeed}),this.isJumping=!0,this.jumpCount++,this.animation.overrideProperty("wiggleSpeed",5),this.animation.overrideProperty("wiggleSpeed",2),this.animation.overrideProperty("wiggleSegments",!0),this.hasSFX&&(this.sfx.jump[0].pause(),this.sfx.jump[0].currentTime=0,this.sfx.jump[0].play()),this.body.collisionFilter.mask=Constants.TRIGGER_CATEGORY,this.platformPassthrough=!0),this.jumpJustPressed=!0):this.jumpJustPressed=!1;let e=1==this.direction?"idle_right":"idle_left";!this.isJumping&&this.blocked.down||(e=1==this.direction?"jump_right":"jump_left"),this.platformPassthrough&&this.body.velocity.y>=0&&0===this.plats.length&&(this.body.collisionFilter.mask=Constants.TRIGGER_CATEGORY|Constants.PLATFORM_CATEGORY,this.platformPassthrough=!1),this.input.right&&(Body.setVelocity(player.body,{x:3,y:player.body.velocity.y}),this.direction=1,this.isJumping||(e="right")),this.input.left&&(Body.setVelocity(player.body,{x:-3,y:player.body.velocity.y}),this.direction=-1,this.isJumping||(e="left")),this.mapPosition[0]=Math.round(this.body.position.x),this.mapPosition[1]=Math.round(this.body.position.y),this.animation.state=e,this.hasSFX&&this.playSFX(this.body.velocity,this.blocked.down)}addSFX(e){this.sfx={},this.hasSFX=!0,e.forEach((e=>{const t=e.currentSrc.split("/").pop().split("_")[0];this.sfx[t]||(this.sfx[t]=[]),this.sfx[t].push(e)})),this.walkCount=0,this.walkInterval=30}playSFX(e,t){if(Math.abs(e.x)>1&&0===this.walkCount&&t){let e=Cool.randomInt(this.sfx.walk.length-1);this.sfx.walk[e].play(),this.walkCount++}else e.x<1||this.walkCount===this.walkInterval||!t?this.walkCount=0:this.walkCount++}}class Scenery{constructor(){}setupBG(){let e=64;for(let t=-32;t<gme.view.width;t+=e){if(Cool.chance(.66)){let s=new HellTextureSprite({x:t+Cool.randomInt(-64,e),y:Cool.randomInt(-64,0),animation:gme.anims.sprites.clouds,stateIndex:Cool.randomInt(0,gme.anims.sprites.clouds.endFrame)});gme.scenes.bg.addSprite(s)}let s=new HellTextureSprite({x:t+Cool.randomInt(-64,e),y:gme.view.height-64-Cool.randomInt(64),animation:gme.anims.sprites.fire,stateIndex:Cool.randomInt(0,gme.anims.sprites.fire.endFrame)});if(gme.scenes.bg.addSprite(s),Cool.chance(.33)){let s=new HellTextureSprite({x:t+Cool.randomInt(-64,e),y:gme.view.halfHeight+Cool.randomInt(128),animation:gme.anims.sprites.land,stateIndex:Cool.randomInt(0,gme.anims.sprites.land.endFrame)});gme.scenes.bg.addSprite(s)}}}setupFG(){let e=512,t=Cool.randomInt(gme.anims.sprites.foregrounds.endFrame);for(let s=-256;s<gme.view.width+256;s+=e)for(let i=-256;i<gme.view.width+256;i+=e){let e=new HellTextureSprite({x:s+Cool.randomInt(-64,64),y:i+Cool.randomInt(-64,64),animation:gme.anims.sprites.foregrounds,stateIndex:t});gme.scenes.fg.addSprite(e)}}reset(){gme.scenes.bg.displaySprites.clear(),gme.scenes.fg.displaySprites.clear()}}const title=document.getElementById("title");function loadingAnimation(){let e="~"+title.textContent+"~";title.textContent=e}const isMobile=Cool.mobilecheck();isMobile&&document.body.classList.add("mobile");const gme=new Game({dps:24,lineWidth:1,zoom:1.5,width:window.innerWidth,height:window.innerHeight,multiColor:!0,checkRetina:!0,stats:!0,lowPerformance:!0,suspend:!0,events:isMobile?["touch"]:["keyboard","mouse"],scenes:["game","splash","loading","bg","fg"],bounds:{left:-1024,top:1024,right:1024,bottom:1024}});let loadingInterval;if(window.parent!==window){console.log("iframe detected"),title.style.display="none";const e=document.createElement("button");e.textContent="start infinite hell 2",document.getElementById("splash").appendChild(e),e.onclick=function(){e.remove(),title.style.display="block",loadingInterval=setInterval(loadingAnimation,1e3/12),gme.load({sprites:"data/sprites.json"},!1)}}else loadingInterval=setInterval(loadingAnimation,1e3/12),gme.load({sprites:"data/sprites.json"},!1);const{Engine:Engine,Bodies:Bodies,Body:Body,Composite:Composite,Runner:Runner,Events:Events}=Matter;let player,firstLevel;gme.levels=[];let doodoo,scenery=new Scenery,physics=new Physics;function startGame(e){e&&(bgMusic(),sfxSetup()),gme.scenes.current="game",Runner.run(physics.engine),physics.display=!0,firstLevel=new Level([0,0],0,0,5,"000000111")}function bgMusic(){const{Doodoo:e}=doodooLib;doodoo=new e({tonic:"F#4",scale:[-4,-2,0,1,3,5,7],parts:[[["F#5","2n"],[null,"4n"],[null,"8n"],["C#5","8n"],["D5","8n"],["E5","8n"],["F#5","8n"],["D5","8n"],["E5","8n"],["F#5","8n"],["A5","8n"],["E5","8n"],["F#5","8n"],["G5","8n"],["B5","8n"],[null,"8n"],["B5","4n"],["F#5","4n"],["D5","4n"],["B4","4n"],["D4","2n"],[null,"4n"],["F#5","4n"],["D5","4n"],["G4","8n"],["A4","8n"],["B4","4n"],["D5","8n"],["D5","8n"],["F#4","8n"],["D4","8n"],["D4","8n"],["D5","8n"],["F#4","8n"],["D4","2n"]]],startDuration:"8n",samples:"./samples/choir/"}),doodoo.setBPM(120)}function sfxSetup(){const e=[],t=["walk_6.mp3","walk_5.mp3","walk_4.mp3","walk_3.mp3","walk_2.mp3","walk_1.mp3","jump_1.mp3"];let s=0;function i(){s++}for(let s=0;s<t.length;s++)n=`./sfx/${t[s]}`,o=void 0,(o=new Audio).addEventListener("canplaythrough",i,!1),o.src=n,o.load(),e.push(o);var n,o;const l=setInterval((()=>{s===t.length&&(clearInterval(l),player.addSFX(e))}),1e3/30)}gme.start=function(){document.getElementById("splash").remove();let e=new HellSprite({x:64,y:gme.view.halfHeight-128,animation:gme.anims.sprites.splash});e.center=!1,gme.scenes.splash.addToDisplay(e);let t=new HellSprite({x:gme.view.halfWidth,y:-128,animation:gme.anims.sprites.instructions});gme.scenes.game.addSprite(t),gme.levels=[],gme.currentLevel=[Constants.PLAYER_START_X,0],gme.lowestLevel=0,player=new Player(Constants.PLAYER_START_X,-256,gme.anims.sprites.player),gme.scenes.game.addToDisplay(player),scenery.setupBG(),scenery.setupFG(),gme.scenes.current="splash"},gme.draw=function(){for(let e=0;e<gme.levels.length;e++)gme.levels[e].updateTiles();gme.ctx.clearRect(0,0,gme.view.width,gme.view.height);const e=[gme.view.halfWidth-player.mapPosition[0],gme.view.halfHeight-player.mapPosition[1]];gme.scenes.bg.update([e[0]/50,e[1]/50]),gme.scenes.bg.display([0,0,gme.width,gme.height]),gme.scenes.current.update(e),gme.scenes.current.display(),physics.render(e),gme.scenes.fg.update([-e[0]/50,-e[1]/50]),gme.scenes.fg.display([0,0,gme.width,gme.height]),player.mapPosition[1]>gme.lowestLevel+gme.view.height&&gme.reset()},gme.reset=function(){for(let e=gme.levels.length-1;e>=0;e--)gme.levels[e].remove();gme.levels=[],gme.currentLevel=[0,0],gme.lowestLevel=0,firstLevel=new Level([0,0],0,0,3,"000000111"),player.reset(),scenery.reset(),scenery.setupBG(),scenery.setupFG(),doodoo&&(doodoo.setTonic("F#4"),doodoo.setBPM(120)),gme.anims.sprites.platforms.cancelOverride()},gme.keyDown=function(e){switch(e){case"a":case"left":player.inputKey("left",!0);break;case"w":case"up":case"x":case"space":if("splash"===gme.scenes.currentName)return startGame(!0);player.inputKey("jump",!0);break;case"z":if("splash"===gme.scenes.currentName)return startGame(!1);break;case"d":case"right":player.inputKey("right",!0);break;case"t":physics.display=!physics.display,console.log("show physies",physics.display);break;case"m":if(!player.sfx)return sfxSetup();player.hasSFX?player.hasSFX=!1:player.hasSFX=!0;break;case"b":if(!doodoo)return bgMusic();doodoo.isPlaying?doodoo.stop():doodoo.play()}},gme.keyUp=function(e){switch(e){case"a":case"left":player.inputKey("left",!1);break;case"w":case"up":case"x":case"space":player.inputKey("jump",!1);break;case"d":case"right":player.inputKey("right",!1);break;case"s":case"down":player.inputKey("down",!1)}};
//# sourceMappingURL=src_maps/gme.min.js.map
